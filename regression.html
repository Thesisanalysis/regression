<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regression Calculator</title>
    <style>
        /* ... your original CSS ... */
    </style>
</head>
<body>
    <h2>Multiple Linear Regression Calculator</h2>

    <div class="instructions">
        <p><strong>How to use:</strong></p>
        <ol>
            <li>Paste your data (with headers in first row)</li>
            <li>Click "Load Data"</li>
            <li>Select your dependent (outcome) variable</li>
            <li>Select your independent (predictor) variables</li>
            <li>Click "Run Analysis"</li>
        </ol>
        <p><strong>Data Format Example:</strong></p>
        <pre>
Overall abuse   SI TOTAL
42  112
32  100
25  114</pre>
    </div>

    <textarea id="tDataInput" rows="10" placeholder="Paste your data here (tab or comma separated)"></textarea>

    <div class="controls">
        <button id="loadDataBtn" class="primary-btn">Load Data</button>
        
        <div id="variableSelection" class="hidden">
            <div class="selection-section">
                <h3>Select Dependent Variable</h3>
                <div id="dependentOptions" class="variable-options"></div>
            </div>
            
            <div class="selection-section">
                <h3>Select Independent Variables</h3>
                <div id="independentOptions" class="variable-options"></div>
            </div>
            
            <button id="confirmSelectionBtn" class="primary-btn">Confirm Selection</button>
        </div>
        
        <div id="analysisControls" class="hidden">
            <button id="analyzeBtn" class="primary-btn">Run Analysis</button>
            <div class="options">
                <label>Significance Level:
                    <select id="alphaLevel">
                        <option value="0.10">10% (α = 0.10)</option>
                        <option value="0.05" selected>5% (α = 0.05)</option>
                        <option value="0.01">1% (α = 0.01)</option>
                    </select>
                </label>
                <label>Include Intercept:
                    <input type="checkbox" id="includeIntercept" checked>
                </label>
            </div>
        </div>
    </div>

    <div id="resultsContainer"></div>
    <div id="errorContainer" style="color: #e74c3c; font-weight: bold;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.5/dist/jstat.min.js"></script>

    <script>
        // Global variables
        let dataset = null;
        let headers = [];
        let selectedDependent = null;
        let selectedIndependents = [];
        let removedVars = [];

        function showError(message) {
            document.getElementById('errorContainer').textContent = message;
        }
        function clearError() {
            document.getElementById('errorContainer').textContent = '';
        }

        function parseData(text) {
            const rows = text.trim().split('\n')
                .map(row => {
                    if (row.includes('\t')) {
                        return row.split('\t').map(cell => cell.trim());
                    }
                    return row.split(',').map(cell => cell.trim());
                });
            
            if (rows.length < 2) {
                showError("Error: Need at least 2 rows (header + data)");
                return null;
            }

            headers = rows[0];
            const dataRows = rows.slice(1).filter(row => row.length === headers.length);

            if (dataRows.length === 0) {
                showError("Error: No valid data rows found");
                return null;
            }

            return {
                headers: headers,
                rows: dataRows,
                numericColumns: identifyNumericColumns(dataRows)
            };
        }

        function identifyNumericColumns(dataRows) {
            const numericCols = [];
            
            for (let col = 0; col < headers.length; col++) {
                let numericCount = 0;
                for (const row of dataRows) {
                    if (!isNaN(parseFloat(row[col])) && row[col].trim() !== '') {
                        numericCount++;
                    }
                }
                if (numericCount / dataRows.length > 0.8) {
                    numericCols.push(col);
                }
            }
            
            return numericCols;
        }

        function showVariableSelector() {
            const depContainer = document.getElementById('dependentOptions');
            const indepContainer = document.getElementById('independentOptions');
            
            depContainer.innerHTML = '';
            indepContainer.innerHTML = '';
            
            dataset.numericColumns.forEach(colIndex => {
                const header = headers[colIndex];
                
                const depBtn = document.createElement('button');
                depBtn.className = 'variable-btn';
                depBtn.textContent = header;
                depBtn.onclick = () => {
                    document.querySelectorAll('#dependentOptions .variable-btn').forEach(b => b.classList.remove('selected'));
                    depBtn.classList.add('selected');
                    selectedDependent = colIndex;
                };
                depContainer.appendChild(depBtn);
                
                const indepBtn = document.createElement('button');
                indepBtn.className = 'variable-btn';
                indepBtn.textContent = header;
                indepBtn.onclick = () => {
                    indepBtn.classList.toggle('selected');
                    updateSelectedIndependents();
                };
                indepContainer.appendChild(indepBtn);
            });
            
            document.getElementById('variableSelection').classList.remove('hidden');
        }

        function updateSelectedIndependents() {
            selectedIndependents = [];
            document.querySelectorAll('#independentOptions .variable-btn.selected').forEach(btn => {
                const header = btn.textContent;
                const colIndex = headers.indexOf(header);
                if (colIndex !== -1 && colIndex !== selectedDependent) {
                    selectedIndependents.push(colIndex);
                }
            });
        }

        function runAnalysis() {
            clearError();
            if (selectedDependent === null || selectedIndependents.length === 0) {
                showError("Please select both dependent and independent variables");
                return;
            }

            const alpha = parseFloat(document.getElementById('alphaLevel').value);
            const includeIntercept = document.getElementById('includeIntercept').checked;
            
            const X = [];
            const y = [];
            const validRows = [];
            
            dataset.rows.forEach(row => {
                let isValid = true;
                const xRow = [];
                
                const yVal = parseFloat(row[selectedDependent]);
                if (isNaN(yVal)) isValid = false;
                
                selectedIndependents.forEach(col => {
                    const xVal = parseFloat(row[col]);
                    if (isNaN(xVal)) isValid = false;
                    xRow.push(xVal);
                });
                
                if (isValid) {
                    if (includeIntercept) xRow.unshift(1);
                    X.push(xRow);
                    y.push(yVal);
                    validRows.push(row);
                }
            });
            
            if (X.length < selectedIndependents.length + (includeIntercept ? 1 : 0)) {
                showError("Error: Not enough valid cases for the number of predictors");
                return;
            }
            
            try {
                const result = performRegression(X, y);
                displayResults(result, alpha, includeIntercept, validRows);
            } catch (error) {
                console.error("Regression error:", error);
                showError("An error occurred during analysis. This is often caused by a mathematical issue with the data, such as constant values or perfectly correlated variables. Please check your data or try selecting different variables.");
            }
        }

        function performRegression(X, y) {
            const X_mat = math.matrix(X);
            const y_mat = math.matrix(y);

            const Xt = math.transpose(X_mat);
            const XtX = math.multiply(Xt, X_mat);
            
            // Check for singularity before attempting inversion
            if (math.det(XtX) === 0) {
                throw new Error("Singular matrix: data contains constant values or perfect multicollinearity.");
            }
            
            const XtX_inv = math.inv(XtX);
            const Xty = math.multiply(Xt, y_mat);
            const b = math.multiply(XtX_inv, Xty);

            const y_pred = math.multiply(X_mat, b);
            const residuals = math.subtract(y_mat, y_pred);
            const n = X.length;
            const p = X[0].length - (X[0][0] === 1 ? 1 : 0);
            const y_mean = math.mean(y_mat);
            // FIXED LINE:
            const SSres = math.sum(math.map(residuals, math.square));
            const SStot = math.sum(math.map(y_mat, val => Math.pow(val - y_mean, 2)));
            const SSreg = SStot - SSres;

            const Rsq = 1 - (SSres / SStot);
            const adjRsq = 1 - ((SSres / (n - p - 1)) / (SStot / (n - 1)));

            const MSE = SSres / (n - p - 1);
            const covMatrix = math.multiply(MSE, XtX_inv);
            const SE = math.sqrt(math.diag(covMatrix));

            const tStats = math.dotDivide(b, SE);
            
            const pValues = tStats.map(t => {
                return 2 * (1 - jStat.studentt.cdf(Math.abs(t), n - p - 1));
            });

            const F = (SSreg / p) / (SSres / (n - p - 1));
            const F_pValue = 1 - jStat.centralF.cdf(F, p, n - p - 1);

            return {
                coefficients: b.valueOf(),
                standardErrors: SE.valueOf(),
                tStats: tStats.valueOf(),
                pValues: pValues,
                Rsq: Rsq,
                adjRsq: adjRsq,
                SSres: SSres,
                SSreg: SSreg,
                SStot: SStot,
                dfRes: n - p - 1,
                dfReg: p,
                y_pred: y_pred.valueOf(),
                residuals: residuals.valueOf(),
                F: F,
                F_pValue: F_pValue,
                X: X,
                y: y_mat.valueOf()
            };
        }

        // ... rest of your code unchanged ...

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loadDataBtn').addEventListener('click', function() {
                clearError();
                const rawData = document.getElementById('tDataInput').value;
                if (!rawData.trim()) {
                    showError("Please paste your data first");
                    return;
                }
                
                const parsedData = parseData(rawData);
                if (!parsedData) return;
                
                dataset = parsedData;
                showVariableSelector();
                document.getElementById('analysisControls').classList.remove('hidden');
            });

            document.getElementById('confirmSelectionBtn').addEventListener('click', function() {
                clearError();
                updateSelectedIndependents();
                if (selectedDependent === null) {
                    showError("Please select a dependent variable");
                    return;
                }
                if (selectedIndependents.length === 0) {
                    showError("Please select at least one independent variable");
                    return;
                }
                document.getElementById('variableSelection').classList.add('hidden');
            });

            document.getElementById('analyzeBtn').addEventListener('click', runAnalysis);
        });
    </script>
</body>
</html>
