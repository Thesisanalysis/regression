<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regression Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            text-align: center;
        }
        .instructions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 15px;
            min-height: 150px;
        }
        .controls {
            margin-bottom: 20px;
        }
        .primary-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: background 0.3s;
        }
        .primary-btn:hover {
            background: #2980b9;
        }
        .hidden {
            display: none;
        }
        #variableSelection {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .selection-section {
            margin-bottom: 20px;
        }
        .variable-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .variable-btn {
            padding: 8px 12px;
            background: #bdc3c7;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .variable-btn:hover {
            background: #95a5a6;
        }
        .variable-btn.selected {
            background: #3498db;
            color: white;
        }
        .options {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            align-items: center;
        }
        select, input[type="checkbox"] {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .regression-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .regression-table th {
            background-color: #3498db;
            color: white;
            padding: 10px;
            text-align: center;
        }
        .regression-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .regression-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .sig {
            font-weight: bold;
            color: #e74c3c;
        }
        .model-summary {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .summary-table th {
            background-color: #2ecc71;
            color: white;
            padding: 8px;
            text-align: left;
        }
        .summary-table td {
            padding: 8px;
            border: 1px solid #ddd;
        }
        .diagnostics {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .residual-plot {
            width: 100%;
            height: 300px;
            background: #fff;
            border: 1px solid #ddd;
            margin-top: 15px;
            position: relative;
        }
        .plot-label {
            position: absolute;
            font-size: 12px;
        }
        .plot-label.x {
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
        }
        .plot-label.y {
            top: 50%;
            left: 5px;
            transform: translateY(-50%) rotate(-90deg);
            transform-origin: left top;
        }
        .residual-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #3498db;
        }
        .sig-note {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .warning {
            color: #e67e22;
            font-weight: bold;
        }
        @media (max-width: 600px) {
            .options {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <h2>Multiple Linear Regression Calculator</h2>

    <div class="instructions">
        <p><strong>How to use:</strong></p>
        <ol>
            <li>Paste your data (with headers in first row)</li>
            <li>Click "Load Data"</li>
            <li>Select your dependent (outcome) variable</li>
            <li>Select your independent (predictor) variables</li>
            <li>Click "Run Analysis"</li>
        </ol>
        <p><strong>Data Format Example:</strong></p>
        <pre>
Overall abuse   SI TOTAL
42  112
32  100
25  114</pre>
    </div>

    <textarea id="tDataInput" rows="10" placeholder="Paste your data here (tab or comma separated)"></textarea>

    <div class="controls">
        <button id="loadDataBtn" class="primary-btn">Load Data</button>
        
        <div id="variableSelection" class="hidden">
            <div class="selection-section">
                <h3>Select Dependent Variable</h3>
                <div id="dependentOptions" class="variable-options"></div>
            </div>
            
            <div class="selection-section">
                <h3>Select Independent Variables</h3>
                <div id="independentOptions" class="variable-options"></div>
            </div>
            
            <button id="confirmSelectionBtn" class="primary-btn">Confirm Selection</button>
        </div>
        
        <div id="analysisControls" class="hidden">
            <button id="analyzeBtn" class="primary-btn">Run Analysis</button>
            <div class="options">
                <label>Significance Level:
                    <select id="alphaLevel">
                        <option value="0.10">10% (α = 0.10)</option>
                        <option value="0.05" selected>5% (α = 0.05)</option>
                        <option value="0.01">1% (α = 0.01)</option>
                    </select>
                </label>
                <label>Include Intercept:
                    <input type="checkbox" id="includeIntercept" checked>
                </label>
            </div>
        </div>
    </div>

    <div id="resultsContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.5/dist/jstat.min.js"></script>

    <script>
        // Global variables
        let dataset = null;
        let headers = [];
        let selectedDependent = null;
        let selectedIndependents = [];
        let removedVars = [];

        function parseData(text) {
            const rows = text.trim().split('\n')
                .map(row => {
                    if (row.includes('\t')) {
                        return row.split('\t').map(cell => cell.trim());
                    }
                    return row.split(',').map(cell => cell.trim());
                });
            
            if (rows.length < 2) {
                alert("Error: Need at least 2 rows (header + data)");
                return null;
            }

            headers = rows[0];
            const dataRows = rows.slice(1).filter(row => row.length === headers.length);

            if (dataRows.length === 0) {
                alert("Error: No valid data rows found");
                return null;
            }

            return {
                headers: headers,
                rows: dataRows,
                numericColumns: identifyNumericColumns(dataRows)
            };
        }

        function identifyNumericColumns(dataRows) {
            const numericCols = [];
            
            for (let col = 0; col < headers.length; col++) {
                let numericCount = 0;
                for (const row of dataRows) {
                    if (!isNaN(parseFloat(row[col])) && row[col].trim() !== '') {
                        numericCount++;
                    }
                }
                if (numericCount / dataRows.length > 0.8) {
                    numericCols.push(col);
                }
            }
            
            return numericCols;
        }

        function showVariableSelector() {
            const depContainer = document.getElementById('dependentOptions');
            const indepContainer = document.getElementById('independentOptions');
            
            depContainer.innerHTML = '';
            indepContainer.innerHTML = '';
            
            dataset.numericColumns.forEach(colIndex => {
                const header = headers[colIndex];
                
                const depBtn = document.createElement('button');
                depBtn.className = 'variable-btn';
                depBtn.textContent = header;
                depBtn.onclick = () => {
                    document.querySelectorAll('#dependentOptions .variable-btn').forEach(b => b.classList.remove('selected'));
                    depBtn.classList.add('selected');
                    selectedDependent = colIndex;
                };
                depContainer.appendChild(depBtn);
                
                const indepBtn = document.createElement('button');
                indepBtn.className = 'variable-btn';
                indepBtn.textContent = header;
                indepBtn.onclick = () => {
                    indepBtn.classList.toggle('selected');
                    updateSelectedIndependents();
                };
                indepContainer.appendChild(indepBtn);
            });
            
            document.getElementById('variableSelection').classList.remove('hidden');
        }

        function updateSelectedIndependents() {
            selectedIndependents = [];
            document.querySelectorAll('#independentOptions .variable-btn.selected').forEach(btn => {
                const header = btn.textContent;
                const colIndex = headers.indexOf(header);
                if (colIndex !== -1 && colIndex !== selectedDependent) {
                    selectedIndependents.push(colIndex);
                }
            });
        }

        function runAnalysis() {
            if (selectedDependent === null || selectedIndependents.length === 0) {
                alert("Please select both dependent and independent variables");
                return;
            }

            const alpha = parseFloat(document.getElementById('alphaLevel').value);
            const includeIntercept = document.getElementById('includeIntercept').checked;
            
            const X = [];
            const y = [];
            const validRows = [];
            
            dataset.rows.forEach(row => {
                let isValid = true;
                const xRow = [];
                
                const yVal = parseFloat(row[selectedDependent]);
                if (isNaN(yVal)) isValid = false;
                
                selectedIndependents.forEach(col => {
                    const xVal = parseFloat(row[col]);
                    if (isNaN(xVal)) isValid = false;
                    xRow.push(xVal);
                });
                
                if (isValid) {
                    if (includeIntercept) xRow.unshift(1);
                    X.push(xRow);
                    y.push(yVal);
                    validRows.push(row);
                }
            });
            
            if (X.length < selectedIndependents.length + (includeIntercept ? 1 : 0)) {
                alert("Error: Not enough valid cases for the number of predictors");
                return;
            }
            
            try {
                const result = performRegression(X, y);
                displayResults(result, alpha, includeIntercept, validRows);
            } catch (error) {
                console.error("Regression error:", error);
                alert("An error occurred during analysis. This is often caused by a mathematical issue with the data, such as constant values or perfectly correlated variables. Please check your data or try selecting different variables.");
            }
        }

        function performRegression(X, y) {
            const X_mat = math.matrix(X);
            const y_mat = math.matrix(y);

            const Xt = math.transpose(X_mat);
            const XtX = math.multiply(Xt, X_mat);
            
            // Check for singularity before attempting inversion
            if (math.det(XtX) === 0) {
                throw new Error("Singular matrix: data contains constant values or perfect multicollinearity.");
            }
            
            const XtX_inv = math.inv(XtX);
            const Xty = math.multiply(Xt, y_mat);
            const b = math.multiply(XtX_inv, Xty);

            const y_pred = math.multiply(X_mat, b);
            const residuals = math.subtract(y_mat, y_pred);
            const n = X.length;
            const p = X[0].length - (X[0][0] === 1 ? 1 : 0);
            const y_mean = math.mean(y_mat);
            const SSres = math.sum(math.square(residuals));
            const SStot = math.sum(math.map(y_mat, val => Math.pow(val - y_mean, 2)));
            const SSreg = SStot - SSres;

            const Rsq = 1 - (SSres / SStot);
            const adjRsq = 1 - ((SSres / (n - p - 1)) / (SStot / (n - 1)));

            const MSE = SSres / (n - p - 1);
            const covMatrix = math.multiply(MSE, XtX_inv);
            const SE = math.sqrt(math.diag(covMatrix));

            const tStats = math.dotDivide(b, SE);
            
            const pValues = tStats.map(t => {
                return 2 * (1 - jStat.studentt.cdf(Math.abs(t), n - p - 1));
            });

            const F = (SSreg / p) / (SSres / (n - p - 1));
            const F_pValue = 1 - jStat.centralF.cdf(F, p, n - p - 1);

            return {
                coefficients: b.valueOf(),
                standardErrors: SE.valueOf(),
                tStats: tStats.valueOf(),
                pValues: pValues,
                Rsq: Rsq,
                adjRsq: adjRsq,
                SSres: SSres,
                SSreg: SSreg,
                SStot: SStot,
                dfRes: n - p - 1,
                dfReg: p,
                y_pred: y_pred.valueOf(),
                residuals: residuals.valueOf(),
                F: F,
                F_pValue: F_pValue,
                X: X,
                y: y_mat.valueOf()
            };
        }

        function displayResults(result, alpha, includeIntercept, validRows) {
            const depVarName = headers[selectedDependent];
            let indepVarNames = selectedIndependents.map(i => headers[i]);
            
            let html = `<h3>Regression Results</h3>`;
            html += `<p>Dependent variable: <strong>${depVarName}</strong></p>`;
            html += `<p>Independent variables: <strong>${indepVarNames.join(', ')}</strong></p>`;
            html += `<p>Number of cases: <strong>${validRows.length}</strong></p>`;
            
            html += `<div class="model-summary">
                        <h4>Model Summary</h4>
                        <table class="summary-table">
                            <tr>
                                <th>R-squared</th>
                                <td>${result.Rsq.toFixed(4)}</td>
                            </tr>
                            <tr>
                                <th>Adjusted R-squared</th>
                                <td>${result.adjRsq.toFixed(4)}</td>
                            </tr>
                            <tr>
                                <th>Residual Standard Error</th>
                                <td>${Math.sqrt(result.SSres / result.dfRes).toFixed(4)}</td>
                            </tr>
                            <tr>
                                <th>F-statistic</th>
                                <td>${result.F.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <th>p-value (Overall Model)</th>
                                <td>${result.F_pValue.toExponential(3)}</td>
                            </tr>
                        </table>
                    </div>`;
            
            html += `<h4>Coefficients</h4>
                    <table class="regression-table">
                        <thead>
                            <tr>
                                <th>Variable</th>
                                <th>Coefficient</th>
                                <th>Std. Error</th>
                                <th>t-value</th>
                                <th>p-value</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            const varNames = includeIntercept ? ['(Intercept)'].concat(indepVarNames) : indepVarNames;
            
            for (let i = 0; i < varNames.length; i++) {
                html += `<tr>
                            <td>${varNames[i]}</td>
                            <td>${result.coefficients[i][0].toFixed(4)}</td>
                            <td>${result.standardErrors[i][0].toFixed(4)}</td>
                            <td>${result.tStats[i][0].toFixed(4)}</td>
                            <td class="${result.pValues[i] < alpha ? 'sig' : ''}">
                                ${result.pValues[i].toExponential(3)}
                            </td>
                        </tr>`;
            }
            
            html += `</tbody></table>`;
            html += `<p class="sig-note">* p < ${alpha} indicates statistical significance</p>`;
            
            html += `<div class="diagnostics">
                        <h4>Residual Diagnostics</h4>
                        <div class="residual-plot" id="residualPlot">
                            <div class="plot-label x">Predicted Values</div>
                            <div class="plot-label y">Residuals</div>
                        </div>
                    </div>`;
            
            document.getElementById('resultsContainer').innerHTML = html;
            drawResidualPlot(result.y_pred, result.residuals);
        }

        function drawResidualPlot(predicted, residuals) {
            const plot = document.getElementById('residualPlot');
            plot.innerHTML = '';
            
            plot.innerHTML = `
                <div class="plot-label x">Predicted Values</div>
                <div class="plot-label y">Residuals</div>
            `;
            
            const width = plot.offsetWidth - 40;
            const height = plot.offsetHeight - 40;
            const margin = { top: 20, right: 20, bottom: 40, left: 40 };
            
            const minPred = Math.min(...predicted.flat());
            const maxPred = Math.max(...predicted.flat());
            const minRes = Math.min(...residuals.flat());
            const maxRes = Math.max(...residuals.flat());
            
            const xScale = val => margin.left + ((val - minPred) / (maxPred - minPred)) * width;
            const yScale = val => margin.top + height - ((val - minRes) / (maxRes - minRes)) * height;
            
            const zeroLine = document.createElement('div');
            zeroLine.style.position = 'absolute';
            zeroLine.style.left = '0';
            zeroLine.style.right = '0';
            zeroLine.style.top = yScale(0) + 'px';
            zeroLine.style.height = '1px';
            zeroLine.style.backgroundColor = '#999';
            plot.appendChild(zeroLine);
            
            for (let i = 0; i < predicted.length; i++) {
                const dot = document.createElement('div');
                dot.className = 'residual-dot';
                dot.style.left = (xScale(predicted[i][0]) - 3) + 'px';
                dot.style.top = (yScale(residuals[i][0]) - 3) + 'px';
                plot.appendChild(dot);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loadDataBtn').addEventListener('click', function() {
                const rawData = document.getElementById('tDataInput').value;
                if (!rawData.trim()) {
                    alert("Please paste your data first");
                    return;
                }
                
                const parsedData = parseData(rawData);
                if (!parsedData) return;
                
                dataset = parsedData;
                showVariableSelector();
                document.getElementById('analysisControls').classList.remove('hidden');
            });

            document.getElementById('confirmSelectionBtn').addEventListener('click', function() {
                updateSelectedIndependents();
                if (selectedDependent === null) {
                    alert("Please select a dependent variable");
                    return;
                }
                if (selectedIndependents.length === 0) {
                    alert("Please select at least one independent variable");
                    return;
                }
                document.getElementById('variableSelection').classList.add('hidden');
            });

            document.getElementById('analyzeBtn').addEventListener('click', runAnalysis);
        });
    </script>
</body>
</html>